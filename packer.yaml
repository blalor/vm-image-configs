variables: ## referenced with {{ user `â€¦` }}
    ## reasonable defaults
    root_passwd: e2162577742148b05964a6926742c55a

    ## taken from the environment
    aws_access_key: '{{ env `AWS_ACCESS_KEY` }}'
    aws_secret_key: '{{ env `AWS_SECRET_KEY` }}'

    ## required to be set with -var
    git_sha: null

builders:
    -   name: centos6-ami-builder-001
        type: amazon-ebs

        access_key: '{{user `aws_access_key`}}'
        secret_key: '{{user `aws_secret_key`}}'

        region: us-east-1
        source_ami: ami-75e4da1c
        instance_type: t1.micro

        ssh_username: ec2-user

        tags:
            distro: 'centos'
            version: '6'
            git_sha: '{{ user `git_sha` }}'
            isotime: '{{ isotime }}'
            timestamp: '{{ timestamp }}'

        ami_name: 'packer-example {{ timestamp }}'
        ami_block_device_mappings:
        -   device_name: /dev/xvda
            volume_size: 10
            delete_on_termination: true

    -   &centos6-vbox-builder-001
        name: centos6-vbox-builder-001
        type: virtualbox-iso
        output_directory: '{{ .Name }}_{{ user `git_sha` }}'

        iso_url: http://mirror.keystealth.org/centos/6.5/isos/x86_64/CentOS-6.5-x86_64-minimal.iso
        iso_checksum: 0d9dc37b5dd4befa1c440d2174e88a87
        iso_checksum_type: md5

        http_directory: kickstart/centos6-minimal

        boot_wait: 10s
        boot_command:
            ## @todo pass root password as boot param
            - '<tab> text console=ttyS0,115200 console=tty0 ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/virtualbox.cfg<enter><wait>'

        disk_size: 10240

        guest_additions_path: 'VBoxGuestAdditions_{{ .Version }}.iso'
        guest_os_type: RedHat_64

        shutdown_command: /sbin/halt -p

        ssh_username: root
        ssh_password: '{{ user `root_passwd` }}'
        ssh_wait_timeout: 30m

        virtualbox_version_file: .vbox_version

        ## UNCOMMENT BELOW IF YOU NEED TO DEBUG THE IMAGE BUILDING STEP IN VIRTUALBOX
        ## https://www.virtualbox.org/wiki/Serial_redirect
        # vboxmanage:
        #     - [ "modifyvm", "{{ .Name }}", "--uart1", "0x3F8", "4" ]
        #     - [ "modifyvm", "{{ .Name }}", "--uartmode1", "file", "{{ pwd }}/console-packer.out" ]

    ## inherit from centos6 vbox builder
    -   &centos7-vbox-builder-001
        <<: *centos6-vbox-builder-001
        name: centos7-vbox-builder-001

        iso_url: http://mirrors.seas.harvard.edu/centos/7.0.1406/isos/x86_64/CentOS-7.0-1406-x86_64-Minimal.iso
        iso_checksum: e3afe3f1121d69c40cc23f0bafa05e5d

        http_directory: kickstart/centos7

        boot_command:
            ## quoting/escaping of the LABEL is critical.  it's literally
            ## "CentOS 07 x86_64", but that needs to be a single argument to
            ## inst.stage2.
            ## https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide/chap-anaconda-boot-options.html
            ## @todo pass root password as boot param
            - '<esc> vmlinuz initrd=initrd.img inst.stage2=hd:LABEL=CentOS\x207\x20x86_64 inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/virtualbox.cfg inst.headless inst.cmdline noshell inst.loglevel=debug console=ttyS0,115200 console=tty0<enter><wait>'

provisioners:
    ## while you can use only and exclude properties to select when provisioners
    ## are run, it's easier to use the PACKER_BUILDER_TYPE and PACKER_BUILD_NAME
    ## env vars in shell scripts to determine if they should be run.  This
    ## allows for build names with patterns, like "-cheffed".

    ## this shell block is really only to specify defaults for others.
    ## copy/pasting the execute_command everwhere is crazy trouble-prone.
    -   &shell_default
        type: shell
        execute_command: 'chmod +x {{ .Path }}; {{ .Vars }} sudo -E {{ .Path }}'
        scripts:
            - scripts/000-dump_env.sh

    -   <<: *shell_default
        scripts:
            - scripts/010-virtualbox.sh
            - scripts/020-vagrant.sh
            - scripts/025-update.sh
            - scripts/040-cleanup.sh
            - scripts/050-zerodisk.sh
            - scripts/060-lockdown.sh

        ## delete packer provisioner script
    -   type: shell
        inline: 'rm -f /tmp/shell.sh'

post-processors:
    -   type: vagrant
        output: 'vagrant_{{ user `git_sha` }}_{{ .Provider }}.box'
        keep_input_artifact: true
        only:
            - centos6-vbox-builder-001
            - centos7-vbox-builder-001
